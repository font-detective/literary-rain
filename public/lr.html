<html>
	<!-- 
		Created by Luke Mitchell
		https://github.com/lukem512
		December 2015
	-->
	<head>
		<title>Literary Rain</title>

		<!-- Configuration -->
		<script>
			// URL of web font to use
			// See https://www.google.com/fonts for a list
			var fontName = 'Open Sans'
			var fontUrl = 'https://fonts.googleapis.com/css?family=Open+Sans';

			// Turn these on and off
			useStyles = true;
			useVariants = true;
			useWeights = true;

			// Number of words to write
			// This is currently random, between the bounds
			var minSentenceLength = 1;
			var maxSentenceLength = 15;
			var sentenceLength = Math.floor(Math.random() * (maxSentenceLength - minSentenceLength)) + minSentenceLength;

			// Size of font
			// This is currently random, between the bounds
			var minFontSize = 10;
			var maxFontSize = 50;
			var fontSize = Math.floor(Math.random() * (maxFontSize - minFontSize)) + minFontSize;
		</script>

		<script>
			// Majid Laissi
			// http://stackoverflow.com/questions/14446447/javascript-read-local-text-file
			function readTextFile(file, callback) {
			    var rawFile = new XMLHttpRequest();
			    rawFile.open("GET", file, true);
			    rawFile.onreadystatechange = function () {
			        if(rawFile.readyState === 4) {
			            if(rawFile.status === 200 || rawFile.status == 0) {
			                var allText = rawFile.responseText;
			                callback(allText.split(/\s+/));
			            }
			        }
			    }
			    rawFile.send(null);
			}
		</script>

		<!-- Vendor scripts -->
		<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	</head>

	<body>
		<p>Want many, many images containing text in a particular font? Want it on a range of in-vogue backgrounds? This is a the script for you!</p>
		<canvas id="lrCanvas">You'll need a browser capable of supporting <a href="http://www.w3schools.com/html/html5_canvas.asp">canvas</a>.</canvas>
		<script>
			var canvas = document.getElementById('lrCanvas');
			var ctx = canvas.getContext('2d');

			var link = document.createElement('link');
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = fontUrl;
			document.getElementsByTagName('head')[0].appendChild(link);

			// Wait for background image to load...
			var img = new Image();
			img.onload = function() {
				// Trick from http://stackoverflow.com/questions/2635814/
				var image = new Image;
				image.src = link.href;
				image.onerror = function() {
					readTextFile("words.txt", function(words) {
						// Pick some words
						var text = "";
						for (i = 0; i < sentenceLength; i++) {
							var index = Math.floor(Math.random() * words.length);
							text = text + words[index] + " ";
						}

						// Construct font style string
						var fontString = fontSize + 'px "' + fontName + '"';

						if (useStyles) {
							// 5x more likely to be normal
							var styles = ['italic', 'oblique', '', '', '', '', ''];
							var style = styles[Math.floor(Math.random() * styles.length)];
							if (style != '') {
								style = style + ' ';
							}
							fontString = style + fontString;
						}

						if (useVariants) {
							// 5x more likely to be normal
							var variants = ['small-caps', '', '', '', '', ''];
							var variant = variants[Math.floor(Math.random() * variants.length)];
							if (variant != '') {
								variant = variant + ' ';
							}
							fontString = variant + fontString;
						}

						if (useWeights) {
							// 5x more likely to be normal
							var weights = ['lighter', 'light', 'bold', 'bolder', '', '', '', '', ''];
							var weight = weights[Math.floor(Math.random() * weights.length)];
							if (weight != '') {
								weight = weight + ' ';
							}
							fontString = weight + fontString;
						}

						console.log('Using font: ' + fontString);

						// Draw to canvas
						// Resizing if necessary
						ctx.font = fontString;
					    ctx.textBaseline = 'top';

					    var width = ctx.measureText(text).width;
						if(width > 100) {
							canvas.width = width;
							// This has to be set again after resize
							ctx.font = fontString;
						}

						// Do it already!
						ctx.drawImage(img, 0, 0);
						ctx.fillText(text, 0, 100);

					    // Save image
					    var dataURL = canvas.toDataURL();

					    // Post to server
					    $.ajax({
							type: "POST",
							url: "/upload",
							data: { 
								imgBase64: dataURL
							}
						}).done(function(o) {
							// Success! 
						});
					});
				};
			};

			// Set the background image source
			readTextFile("images.txt", function(images) {
				var index = Math.floor(Math.random() * images.length);
				img.src = images[index];
			});
		</script>
	</body>
</html>